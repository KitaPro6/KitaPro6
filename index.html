<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kindergarten-Bibliothek</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Kindergarten-Bibliothek">
  <script src="jsQR.js"></script>
  <style>
    body { font-family: sans-serif; padding: 25px; background: #f6f6ff; margin: 0; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .search-container { display: flex; align-items: center; gap: 8px; flex: 1; max-width: 450px; }
    #search { flex: 1; font-size: 1em; padding: 8px; border: 2px solid #ddd; border-radius: 6px; }
    .qr-button {
      background: transparent;
      color: #007bff;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.15s;
    }
    .qr-button:hover { background: #eee; }
    .clear-search-button {
      background: transparent;
      border: none;
      font-size: 18px;
      padding: 0 8px;
      border-radius: 6px;
      cursor: pointer;
      color: #666;
      transition: background 0.15s;
    }
    .clear-search-button:hover { background: #eee; }
    .show-all-button {
      background: #007bff; color: #fff; border: none; font-size: 14px;
      padding: 4px 10px; border-radius: 6px; cursor: pointer; margin-left: 2px;
      transition: background 0.15s;
    }
    .show-all-button:hover { background: #0056b3; }
    .admin-corner { display: flex; flex-direction: column; gap: 5px; }
    .book { background: #fff; margin: 10px 0; padding: 12px; border-radius: 7px; box-shadow: 0 0 6px #ccc; overflow: hidden; min-height: 115px; }
    .cover { float: left; max-width: 70px; max-height: 100px; margin-right: 12px; margin-bottom: 6px; border: 1px solid #eee; border-radius: 3px;}
    .book-details { overflow: hidden; }
    .admin-controls { margin-top: 10px; }
    .edit-fields input, .edit-fields label { margin: 2px 0; display: block; width: 90%; padding: 4px; }
    .edit-fields.hidden { display: none; }
    .edit-fields .neu-checkbox { width: auto; display: inline-block; margin-left: 0; margin-right: 8px; }
    .edit-fields .neu-label { display: inline-block; width: auto; margin-right: 0; font-weight: bold; color: #e88; }
    #modal { display: none; position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 10;}
    #modal-content { background: #fff; padding: 30px; border-radius: 10px; min-width: 320px; max-width: 90vw; max-height: 90vh; overflow: auto; }
    #qr-reader { width: 100%; max-width: 400px; }
    #admin-login {margin-top:10px;}
    #admin-login.hidden { display: none; }
    #admin-panel {margin-top:10px;}
    #admin-panel.hidden { display: none; }
    #admin-panel input { display: block; margin: 5px 0; padding: 5px; width: 200px; }
    #log-output {white-space: pre; font-size: 0.95em; background: #eef; padding: 10px; border-radius: 6px; max-height:150px; overflow-y:auto;}
    #book-list {margin-top:20px;}
    #new-books {margin-top:0; margin-bottom:10px;}
    button {font-size:1em; padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;}
    button:hover { background: #e9e9e9; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .pagination-bar {text-align:center; margin:24px 0 8px 0;}
    .pagination-btn {
      background: #eee;
      color: #333;
      border: none;
      font-size: 15px;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      margin: 0 5px;
      transition: background 0.15s;
    }
    .pagination-btn:hover { background: #ddd; }
    .pagination-info { font-size: 15px; color: #444; margin: 0 10px; }
    .neu-badge {
      color: #e88; background: #fff4ee; border-radius: 6px; font-weight: bold;
      font-size: 13px; margin-left: 8px; padding: 1px 6px; border: 1px solid #e6b;
      vertical-align: middle;
    }
    @media (max-width: 768px) {
      body { padding: 15px; }
      .header { flex-direction: column; gap: 15px; align-items: stretch; }
      .search-container { max-width: 100%; }
      .admin-corner { flex-direction: row; justify-content: center; }
      #new-books {font-size: 15px;}
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>üìö Kindergarten-Bibliothek</h1>
      <div class="search-container">
        <input type="text" id="search" placeholder="Suchen nach Titel, ID, Kategorie, Schlagwort ..." autocomplete="off">
        <button class="qr-button" onclick="startQRScanner()" title="QR-Code scannen">üì∑</button>
        <button class="clear-search-button" onclick="clearSearch()" title="Suchfeld leeren">‚úñÔ∏è</button>
        <button class="show-all-button" onclick="showAllBooks()" title="Alle anzeigen">Alle anzeigen</button>
      </div>
      <div id="new-books"></div>
    </div>
    <div class="admin-corner">
      <button onclick="showAdminLogin()">üîë Admin</button>
      <div id="admin-login" class="hidden">
        <input type="password" id="admin-pw" placeholder="Passwort" style="width: 120px; margin-bottom: 5px;">
        <button onclick="checkAdmin()">Login</button>
      </div>
    </div>
  </div>

  <div id="book-list"></div>

  <div id="modal">
    <div id="modal-content"></div>
  </div>

  <div id="admin-panel" class="hidden">
    <h3>Buch hinzuf√ºgen</h3>
    <input id="new-id" placeholder="ID (z.B. B-0003)">
    <input id="new-title" placeholder="Titel">
    <input id="new-cat" placeholder="Kategorie">
    <input id="new-keywords" placeholder="Schlagworte">
    <input id="new-age" placeholder="Alter (z.B. 3-6)">
    <button onclick="addBook()">‚ûï Hinzuf√ºgen</button>
    <button onclick="exportData()">üìÅ Backup erstellen</button>
    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
    <button onclick="document.getElementById('import-file').click()">üìÇ Backup laden</button>
    <button onclick="logoutAdmin()">Logout</button>
    <h3>Ausleihverlauf</h3>
    <div id="log-output"></div>
    <button onclick="resetData()">Alles zur√ºcksetzen</button>
  </div>

  <script>
    // ... Service Worker und Datenbank Initialisierung wie vorher ...

    // ... Alle bisherigen Funktionen wie vorher ...

    // Erg√§nzt: Modal f√ºr Bild & Beschreibung
    function showImageModal(index) {
      const book = books[index];
      let modalHtml = `<div style="text-align:center;">
        <img src="${book.img}" style="max-width:90vw;max-height:60vh;border-radius:10px;box-shadow:0 0 16px #999;"><br><br>`;
      if (adminMode) {
        modalHtml += `
          <textarea id="book-desc" style="width:90%;height:80px;padding:8px;border-radius:7px;" placeholder="Beschreibung eingeben...">${book.description || ''}</textarea><br>
          <button onclick="saveDescription(${index})">üíæ Beschreibung speichern</button>
        `;
      } else if (book.description) {
        modalHtml += `<div style="margin-top:10px;color:#333;background:#f9f9ef;padding:12px;border-radius:7px;">${book.description}</div>`;
      }
      modalHtml += `<br><button onclick="closeModal()">Schlie√üen</button></div>`;
      document.getElementById("modal-content").innerHTML = modalHtml;
      document.getElementById("modal").style.display = "flex";
    }

    function saveDescription(index) {
      books[index].description = document.getElementById("book-desc").value;
      saveData();
      closeModal();
      renderBooks(document.getElementById("search").value);
      renderNewBooks();
    }

    // ... In Buchdaten beim Hinzuf√ºgen/Bearbeiten: description mitschreiben ...
    // Beim Hinzuf√ºgen:
    books.push({id, title, category: cat, keywords: keys, age, status: "verf√ºgbar", group: "", img:"", borrower: "", borrowDate: "", isNew:false, newSince:"", description:""});

    // ... In renderNewBooks(): Bild anzeigen und klickbar ...
    function renderNewBooks() {
      const container = document.getElementById("new-books");
      const now = Date.now();
      const sixWeeksMs = 6 * 7 * 24 * 60 * 60 * 1000;
      let changed = false;
      books.forEach(b => {
        if (b.isNew && b.newSince && (now - new Date(b.newSince).getTime() > sixWeeksMs)) {
          b.isNew = false;
          b.newSince = "";
          changed = true;
        }
      });
      if (changed) saveData();
      const newBooks = books.filter(b =>
        b.isNew &&
        b.newSince &&
        (now - new Date(b.newSince).getTime() <= sixWeeksMs)
      );
      if (newBooks.length === 0) {
        container.innerHTML = "";
        return;
      }
      container.innerHTML = `
        <div style="background:#fffbcc;border-radius:8px;padding:10px;margin-bottom:12px;">
          <strong>‚ú® Neue B√ºcher:</strong>
          <div style="display:flex;flex-wrap:wrap;gap:18px;margin-top:10px;">
            ${newBooks.map(b => `
              <div style="width:140px;text-align:center;">
                <div>
                  ${b.img ? `<img src="${b.img}" style="width:70px;height:100px;object-fit:cover;border-radius:6px;border:1px solid #e6b;box-shadow:0 0 6px #ccc;cursor:pointer;" onclick="showImageModal(${books.indexOf(b)})">` : ""}
                </div>
                <div style="margin:5px 0 0 0;font-size:15px;">
                  ${b.id} ‚Äì ${b.title}
                  <span class="neu-badge">Neu!</span>
                </div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
    }

    // ... Rest wie vorher ...

  </script>
</body>
</html>
