<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kindergarten-Bibliothek</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9faff; margin: 0;}
    .container { max-width: 900px; margin: 0 auto; padding: 24px;}
    .title-search-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 14px;
      max-width: 430px;
      margin: 0 auto 10px auto;
      justify-content: flex-start;
    }
    .main-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #007aff;
      margin: 0;
      flex-shrink: 0;
      min-width: 180px;
      letter-spacing: 0.03em;
    }
    .search-wrapper {
      display: flex;
      align-items: center;
      background: #fff;
      border: 1.5px solid #b6d8ff;
      border-radius: 9px;
      box-shadow: 0 2px 8px #eaf3ff;
      padding: 2px 6px;
      flex: 1;
      max-width: 230px;
    }
    .search-wrapper input {
      flex: 1;
      border: none;
      background: transparent;
      padding: 8px 6px;
      font-size: 1em;
      outline: none;
    }
    .search-wrapper .qr-button,
    .search-wrapper .clear-search-button {
      background: none;
      border: none;
      padding: 0 8px;
      color: #007aff;
      font-size: 1.3em;
      cursor: pointer;
      border-radius: 7px;
      transition: background 0.2s;
    }
    .search-wrapper .qr-button:hover,
    .search-wrapper .clear-search-button:hover {
      background: #eaf3ff;
    }
    /* --- NEU-Bereich --- */
    #new-books-area {
      background: #eaf3ff;
      border-radius: 12px;
      padding: 10px 10px 0 10px;
      margin: 0 0 16px 0;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }
    #new-books-head {
      font-weight: bold;
      color: #007aff;
      font-size: 1.1em;
      margin-bottom: 8px;
      text-align: left;
      position: sticky;
      top: 0;
      left: 0;
      z-index: 2;
      background: #eaf3ff;
      padding: 8px 0 8px 0;
      width: 100%;
    }
    #new-books-scroll {
      display: flex;
      gap: 14px;
      overflow-x: auto;
      padding-bottom: 8px;
    }
    #new-books-scroll .book {
      min-width: 180px;
      max-width: 200px;
      flex: 0 0 auto;
      background: #eaf3ff;
    }
    .book-details .status-verfuegbar, .book-details .status-geliehen {
      font-size: 0.8em;
      display: block;
      margin-top: 2px;
      margin-bottom: 2px;
      word-break: break-word;
      line-height: 1.2;
    }
    /* Restliche Styles wie gehabt... */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title-search-row">
        <h1 class="main-title">üìö Kindergarten-Bibliothek</h1>
        <div class="search-wrapper">
          <button class="qr-button" onclick="showQRModal()" title="QR-Code scannen">üì∑</button>
          <input type="text" id="search" placeholder="Suchen ..." autocomplete="off" oninput="onSearchChange()">
          <button class="clear-search-button" onclick="clearSearch()" title="Suchfeld leeren">‚úñÔ∏è</button>
        </div>
      </div>
      <div id="new-books"></div>
    </div>
    <div id="book-list"></div>
    <div class="pagination" id="pagination"></div>
    <!-- Admin/Modalbereiche folgen in Teil 2 -->
  </div>
  <script>
    // Initiale Variablen, Gruppen, Log etc.
    let books = [];
    let log = [];
    let page = 1;
    let admin = false;
    let editingIdx = null;
    let verliehenGruppeIdx = 0;
    let logPage = 1;
    const gruppenSymbole = ["‚≠ê","‚òÄÔ∏è","üåô","üåà","üíß","‚ùÑÔ∏è","üó£Ô∏è"];
    const gruppenNamen = ["Sterne","Sonne","Mond","Regenbogen","Regentropfen","Schneeflocken","Sprachf√∂rderung"];

    function trimLogByDate() {
      const now = Date.now();
      log = log.filter(entry => {
        const match = entry.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4}), (\d{1,2}):(\d{2}):(\d{2}):/);
        if (!match) return true;
        const day = Number(match[1]);
        const month = Number(match[2]);
        const year = Number(match[3]);
        const hour = Number(match[4]);
        const min = Number(match[5]);
        const sec = Number(match[6]);
        const entryDate = new Date(year, month - 1, day, hour, min, sec).getTime();
        return (now - entryDate) < 365*24*60*60*1000;
      });
    }

    // Initialisierung
    if(!localStorage.books) {
      books = [
        {id:"B-0001", title:"Die kleine Raupe", category:"Bilderbuch", age:"3-6", status:"verf√ºgbar", img:"", neu:true, description:"Ein Klassiker f√ºr Kinder."},
        {id:"B-0002", title:"Leo Lausemaus", category:"Vorlesebuch", age:"4-7", status:"verf√ºgbar", img:"", neu:false, description:"Abenteuer von Leo Lausemaus."},
        {id:"B-0003", title:"Conni kommt", category:"Bilderbuch", age:"3-6", status:"verf√ºgbar", img:"", neu:true, description:"Conni erlebt den Kindergarten."}
      ];
      log = [];
      saveData();
    } else {
      books = JSON.parse(localStorage.books);
      log = JSON.parse(localStorage.log || "[]");
      trimLogByDate();
      saveData();
    }

    function renderNewBooks() {
      const neu = books.filter(b=>b.neu);
      if(!neu.length) { document.getElementById("new-books").innerHTML = ""; return;}
      let html = `<div id="new-books-area">
          <div id="new-books-head">Neue B√ºcher</div>
          <div id="new-books-scroll">`;
      neu.forEach((book,idx)=>{
        let statusHtml = '';
        if(book.status === "verf√ºgbar"){
          statusHtml = `<span class="status-verfuegbar"><span class="symbol">üìó</span> Verf√ºgbar</span>`;
        } else {
          statusHtml = `<span class="status-geliehen"><span class="symbol">üìï</span> Geliehen von ${book.borrower || "?"}</span>`;
        }
        html += `<div class="book">
            ${book.img ? `<img src="${book.img}" class="cover" onclick="showImageModal(${books.indexOf(book)})">` : ""}
            <div class="book-details">
              <strong>${book.id} ‚Äì ${book.title}</strong><br>
              Kategorie: ${book.category}<br>
              Alter: ${book.age}<br>
              ${statusHtml}
              ${book.status === "verf√ºgbar"
                  ? `<button onclick="ausleihenStart(${books.indexOf(book)})">Ausleihen</button>`
                  : `<button onclick="zurueckgebenStart(${books.indexOf(book)})">Zur√ºckstellen</button>`
              }
              ${(admin ? `<button class="edit-btn" onclick="editBook(${books.indexOf(book)})">Bearbeiten</button>`:"")}
            </div>
          </div>`;
      });
      html += `</div></div>`;
      document.getElementById("new-books").innerHTML = html;
    }

    // Der Rest folgt in Teil 2!
        // Buchlisten-Rendern (Hauptliste)
    function renderBooks(searchVal="") {
      let filtered = books.filter(b => {
        let s = searchVal.trim().toLowerCase();
        if(!s) return true;
        return (b.title+b.id+b.category+b.age).toLowerCase().includes(s);
      });

      const total = filtered.filter(b=>!b.neu).length;
      const maxPage = Math.max(1,Math.ceil(total/30));
      if(page > maxPage) page = maxPage;

      // Neue B√ºcher werden separat angezeigt
      if(page === 1 && !searchVal) {
        renderNewBooks();
      } else {
        document.getElementById("new-books").innerHTML = "";
      }

      let html = "";
      let booksToShow = filtered.filter(b=>!b.neu).slice((page-1)*30, page*30);
      booksToShow.forEach((book,idx) => {
        let statusHtml = '';
        if(book.status === "verf√ºgbar"){
          statusHtml = `<span class="status-verfuegbar"><span class="symbol">üìó</span> Verf√ºgbar</span>`;
        } else {
          statusHtml = `<span class="status-geliehen"><span class="symbol">üìï</span> <span style="font-size:0.9em;">Geliehen von ${book.borrower || "?"}</span></span>`;
        }
        html += `
        <div class="book">
          ${book.img ? `<img src="${book.img}" class="cover" onclick="showImageModal(${books.indexOf(book)})">` : ""}
          <div class="book-details">
            <strong>${book.id} ‚Äì ${book.title}</strong><br>
            Kategorie: ${book.category}<br>
            Alter: ${book.age}<br>
            ${statusHtml}
            ${book.status === "verf√ºgbar"
                ? `<button onclick="ausleihenStart(${books.indexOf(book)})">Ausleihen</button>`
                : `<button onclick="zurueckgebenStart(${books.indexOf(book)})">Zur√ºckstellen</button>`
            }
            ${(admin ? `<button class="edit-btn" onclick="editBook(${books.indexOf(book)})">Bearbeiten</button>`:"")}
          </div>
        </div>`;
      });
      document.getElementById("book-list").innerHTML = html;

      let pagHtml = "";
      for(let i=1;i<=maxPage;i++) {
        pagHtml += `<button onclick="gotoPage(${i})" class="${i===page?'active':''}">${i}</button>`;
      }
      document.getElementById("pagination").innerHTML = pagHtml;
    }

    function gotoPage(p) { page = p; renderBooks(document.getElementById("search").value); }
    function onSearchChange() { page = 1; renderBooks(document.getElementById("search").value);}
    function clearSearch() { document.getElementById("search").value = ""; page = 1; renderBooks();}

    // Bildanzeige-Modal
    function showImageModal(idx) {
      const b = books[idx];
      let html = `<strong>${b.id} ‚Äì ${b.title}</strong><br>`;
      if(b.img) html += `<img src="${b.img}" style="max-width:180px; border-radius:8px;"><br>`;
      html += `<br>Kategorie: ${b.category}<br>Alter: ${b.age}<br>`;
      html += `<br>${b.description||""}<br>`;
      html += `<br><button onclick="closeModal()">Schlie√üen</button>`;
      document.getElementById("modal-content").innerHTML = html;
      document.getElementById("modal").style.display = "flex";
    }
    function closeModal() { document.getElementById("modal").style.display = "none"; }

    // Ausleihen/Zur√ºckgeben
    function ausleihenStart(idx) {
      if(books[idx].status!=="verf√ºgbar") return;
      let modal = `<div style="text-align:center;">
        <div>Gruppe ausw√§hlen:</div><div style="margin:10px 0;">`;
      gruppenSymbole.forEach((symb,i) => {
        modal += `<button class="group-btn" onclick="ausleihenGruppe(${idx},${i})" title="${gruppenNamen[i]}">${symb}</button>`;
      });
      modal += `</div>
        <button onclick="closeModal()">Abbrechen</button></div>`;
      document.getElementById("modal-content").innerHTML = modal;
      document.getElementById("modal").style.display = "flex";
    }
    function ausleihenGruppe(idx, gruppeIdx) {
      let modal = `<div style="text-align:center;">
        <div>Buch wirklich f√ºr <span style="font-size:2em;">${gruppenSymbole[gruppeIdx]}</span> ausleihen?</div>
        <button class="save-btn" onclick="ausleihenFinal(${idx},${gruppeIdx})">Ja</button>
        <button onclick="closeModal()">Nein</button>
        </div>`;
      document.getElementById("modal-content").innerHTML = modal;
    }
    function ausleihenFinal(idx, gruppeIdx) {
      books[idx].status = "ausgeliehen";
      books[idx].borrower = gruppenNamen[gruppeIdx];
      log.push(`${new Date().toLocaleString()}: ${books[idx].id} ausgeliehen an ${gruppenNamen[gruppeIdx]}`);
      trimLogByDate();
      closeModal();
      renderBooks(document.getElementById("search").value);
      renderNewBooks();
      updateLog();
      saveData();
      renderVerliehenUebersicht(gruppeIdx);
    }
    function zurueckgebenStart(idx) {
      if(books[idx].status!=="ausgeliehen") return;
      let modal = `<div style="text-align:center;">
        <div>Buch wirklich zur√ºckstellen?</div>
        <button class="save-btn" onclick="zurueckgebenFinal(${idx})">Ja</button>
        <button onclick="closeModal()">Nein</button>
        </div>`;
      document.getElementById("modal-content").innerHTML = modal;
      document.getElementById("modal").style.display = "flex";
    }
    function zurueckgebenFinal(idx) {
      books[idx].status = "verf√ºgbar";
      log.push(`${new Date().toLocaleString()}: ${books[idx].id} zur√ºckgegeben von ${books[idx].borrower}`);
      books[idx].borrower = "";
      trimLogByDate();
      closeModal();
      renderBooks(document.getElementById("search").value);
      renderNewBooks();
      updateLog();
      saveData();
      renderVerliehenUebersicht(verliehenGruppeIdx);
    }

    // Admin Login/Logout
    function showAdminLogin() {
      document.getElementById("admin-login").classList.remove("hidden");
      document.getElementById("admin-panel").classList.add("hidden");
      document.getElementById("admin-login-btn").style.display="none";
    }
    function checkAdmin() {
      const pw = document.getElementById("admin-pw").value;
      if(pw==="kitadmin") {
        admin = true;
        document.getElementById("admin-login").classList.add("hidden");
        document.getElementById("admin-panel").classList.remove("hidden");
        document.getElementById("backup-section").classList.remove("hidden");
        renderBooks(document.getElementById("search").value);
        renderNewBooks();
        renderVerliehenUebersicht(verliehenGruppeIdx);
      } else {
        alert("Falsches Passwort!");
      }
    }
    function logoutAdmin() {
      admin = false;
      document.getElementById("admin-panel").classList.add("hidden");
      document.getElementById("admin-login-btn").style.display="inline-block";
      document.getElementById("admin-login").classList.add("hidden");
      document.getElementById("backup-section").classList.add("hidden");
      document.getElementById("verliehen-uebersicht").classList.add("hidden");
      renderBooks(document.getElementById("search").value);
      renderNewBooks();
    }

    // Der Rest (Backup, Log, QR, Kamera) folgt in Teil 3!
        // --- Backup-Bereich mit Passwort-Abfrage ---
    let adminAction = null;
    function confirmAdminAction(action) {
      adminAction = action;
      let msg = "";
      if(action==="export") msg = "Backup erstellen. Bitte Admin-Passwort eingeben:";
      if(action==="import") msg = "Backup hochladen. Bitte Admin-Passwort eingeben:";
      if(action==="reset") msg = "Alle Daten l√∂schen. Bitte Admin-Passwort eingeben:";
      document.getElementById("admin-action-msg").innerText = msg;
      document.getElementById("admin-action-pw").value = "";
      document.getElementById("admin-action-modal").style.display = "flex";
    }
    function closeAdminActionModal() {
      adminAction = null;
      document.getElementById("admin-action-modal").style.display = "none";
    }
    function doAdminAction() {
      const pw = document.getElementById("admin-action-pw").value;
      if(pw!=="kitadmin") { alert("Falsches Passwort!"); return;}
      document.getElementById("admin-action-modal").style.display = "none";
      if(adminAction==="export") exportData();
      if(adminAction==="import") document.getElementById('import-file').click();
      if(adminAction==="reset") resetData();
      adminAction = null;
    }

    function exportData() {
      const data = {books,log};
      const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }
    function importData(ev) {
      const file = ev.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          books = data.books||[];
          log = data.log||[];
          trimLogByDate();
          saveData();
          renderBooks(document.getElementById("search").value);
          renderNewBooks();
          updateLog();
          renderVerliehenUebersicht(verliehenGruppeIdx);
        } catch {
          alert("Fehler beim Laden!");
        }
      }
      reader.readAsText(file);
    }
    function resetData() {
      if(confirm("Wirklich alle Daten l√∂schen?")) {
        books = []; log = [];
        saveData();
        renderBooks(); renderNewBooks(); updateLog();
        renderVerliehenUebersicht(verliehenGruppeIdx);
      }
    }

    // --- LOG: Paginierung und Anzeige ---
    function updateLog() {
      trimLogByDate();
      const maxPerPage = 100;
      const totalPages = Math.max(1, Math.ceil(log.length / maxPerPage));
      if (logPage > totalPages) logPage = totalPages;
      const startIdx = log.length - logPage * maxPerPage;
      const endIdx = log.length - (logPage - 1) * maxPerPage;
      const logsToShow = log.slice(Math.max(0, startIdx), endIdx);
      document.getElementById("log-output").innerText = logsToShow.join("\n");

      // Paginierung anzeigen
      let pagHtml = "";
      for(let i=1; i<=totalPages; i++) {
        pagHtml += `<button onclick="setLogPage(${i})" ${i===logPage?'style="font-weight:bold;background:#b6d8ff"':''}>${i}</button>`;
      }
      document.getElementById("log-pagination").innerHTML = pagHtml;
    }
    function setLogPage(p) {
      logPage = p;
      updateLog();
    }

    // --- Admin: Verliehen √úbersicht mit Tabs ---
    function renderVerliehenUebersicht(selectedGruppeIdx = 0) {
      verliehenGruppeIdx = selectedGruppeIdx;
      // Bereich ist wirklich nur f√ºr Admin sichtbar
      if (!admin) {
        document.getElementById("verliehen-uebersicht").classList.add("hidden");
        return;
      }
      document.getElementById("verliehen-uebersicht").classList.remove("hidden");
      // Tabs
      let tabs = "";
      gruppenNamen.forEach((grp, i) => {
        tabs += `<button onclick="renderVerliehenUebersicht(${i})" class="${i==selectedGruppeIdx?'active':''}">${grp} ${gruppenSymbole[i]}</button>`;
      });
      document.getElementById("gruppen-tabs").innerHTML = tabs;
      // Daten f√ºr diese Gruppe
      const aktuellGeliehen = books.filter(b => b.status === "ausgeliehen" && b.borrower === gruppenNamen[selectedGruppeIdx]);
      let content = `<b>${aktuellGeliehen.length}</b> Buch${aktuellGeliehen.length !== 1 ? "er" : ""} momentan verliehen.<br><ul>`;
      aktuellGeliehen.forEach(b => {
        // Datum aus Log holen
        const ausleihLog = log.filter(entry =>
          entry.includes(b.id) &&
          entry.includes("ausgeliehen an " + b.borrower)
        ).slice(-1)[0];
        const rueckLog = log.filter(entry =>
          entry.includes(b.id) &&
          entry.includes("zur√ºckgegeben von " + b.borrower)
        ).slice(-1)[0];
        let ausleihDatum = ausleihLog ? ausleihLog.split(":")[0] : "?";
        let rueckDatum = rueckLog ? rueckLog.split(":")[0] : "";
        content += `<li><b>${b.title}</b><br>
           Geliehen: ${ausleihDatum}${rueckDatum ? "<br>Zur√ºck: "+rueckDatum : ""}
          </li>`;
      });
      content += "</ul>";
      document.getElementById("gruppen-content").innerHTML = content;
    }

    // --- QR-Code Scanner (offline, jsQR lokal!) ---
    function showQRModal() {
      let html = `<video id="qr-video" style="width:260px; border-radius:12px;"></video><br>
      <button onclick="closeQRModal()">Abbrechen</button>
      <div id="qr-result"></div>`;
      document.getElementById("qr-modal-content").innerHTML = html;
      document.getElementById("qr-modal").style.display = "flex";
      startQRScanner();
    }
    function closeQRModal() {
      document.getElementById("qr-modal").style.display = "none";
      stopQRScanner();
    }
    let qrStream = null;
    function startQRScanner() {
      const video = document.getElementById("qr-video");
      navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(stream=>{
        qrStream = stream; video.srcObject = stream; video.setAttribute("playsinline",true); video.play();
        scanLoop(video);
      });
    }
    function stopQRScanner() {
      if(qrStream) qrStream.getTracks().forEach(track=>track.stop());
      qrStream = null;
    }
    function scanLoop(video) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      function loop() {
        if(!qrStream) return;
        if(video.readyState !== video.HAVE_ENOUGH_DATA){ requestAnimationFrame(loop); return;}
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data,canvas.width,canvas.height);
        if(code) {
          document.getElementById("qr-result").innerHTML = "<strong>QR gefunden:</strong> "+code.data;
          document.getElementById("search").value = code.data;
          closeQRModal();
          onSearchChange();
        } else {
          requestAnimationFrame(loop);
        }
      }
      loop();
    }

    // --- KAMERA Vollbild, 3:4 Hochformat ---
    // ... (Dein Kamera-Code bleibt wie im Original, da bereits offline!)

    // --- Initiales Rendern ---
    renderBooks();
    renderNewBooks();
    updateLog();

  </script>
  <!-- jsQR offline: Lege jsqr.min.js ins Projektverzeichnis und binde es lokal ein -->
  <script src="jsqr.min.js"></script>
</body>
</html>
