<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kindergarten-Bibliothek</title>
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/5/57/Book_icon_2.png">
  <style>
    /* --- Minimal styles f√ºr Layout und Buttons --- */
    body { font-family: Arial, sans-serif; background: #f9faff; margin: 0;}
    .container { max-width: 900px; margin: 0 auto; padding: 24px;}
    .header { display: flex; justify-content: space-between; align-items: flex-start; gap: 24px;}
    h1 { margin: 0 0 10px 0; font-size: 2em; color: #007aff;}
    .search-container { display: flex; gap: 8px; align-items: center;}
    #search { padding: 8px; font-size: 1em; border-radius: 7px; border: 1.5px solid #b6d8ff;}
    .qr-button, .clear-search-button { background: #fff; color: #007aff; border: none; border-radius: 7px; font-size: 1.1em; padding: 8px; cursor: pointer;}
    .qr-button:hover, .clear-search-button:hover { background: #eaf3ff;}
    .admin-corner { margin-top: 24px;}
    #new-books { margin-top:18px; margin-bottom: 16px;}
    .new-books-box { background: #fffbe8; border: 1.5px solid #ffe5b3; border-radius: 14px; padding: 16px; margin-bottom: 16px;}
    .pagination { margin: 24px 0; text-align: center;}
    .pagination button { margin:2px; padding:7px 14px; border-radius:7px; border:1px solid #b6d8ff; background:#fff; color:#007aff; cursor:pointer;}
    .pagination button.active { background:#007aff; color:#fff; font-weight: bold;}
    .book { display: flex; gap:22px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; margin-bottom: 18px; padding: 12px;}
    .book img.cover { max-width: 90px; border-radius: 8px; }
    .book-details { flex: 1;}
    #modal, #qr-modal {position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.23); display:none; align-items:center; justify-content:center; z-index:10;}
    #modal-content, #qr-modal-content { background:#fff; border-radius:16px; min-width:280px; max-width:350px; padding:24px; box-shadow:0 8px 36px #007aff22;}
    #admin-login, #admin-panel { background:#fff; border-radius:12px; box-shadow: 0 3px 14px #007aff17; padding:18px; margin-bottom:16px;}
    #admin-login.hidden, #admin-panel.hidden { display: none;}
    #admin-panel input, #admin-panel textarea, #admin-panel select { margin:4px 0 8px 0; padding:7px; width:95%; border-radius:7px; border:1.2px solid #b6d8ff;}
    #admin-panel textarea { min-height: 60px;}
    #log-output { font-size:0.95em; background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:8px; max-height:120px; overflow-y:auto; border:1px solid #e6e8fa;}
    .group-btn { margin: 2px; padding: 7px 12px; border-radius: 7px; border: 1.2px solid #eaf3ff; background: #eaf3ff; color: #007aff; cursor: pointer; font-weight: 600;}
    .group-btn:hover { background:#b6d8ff;}
    .edit-btn { background: #ffe5b3; color: #9a6a00; border:1px solid #e6b; border-radius:7px; padding:6px 10px;}
    .edit-btn:hover { background:#fffbe8;}
    .save-btn { background:#007aff; color:#fff; border:none; border-radius:7px; padding:6px 14px;}
    .save-btn:hover { background:#0050a8;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üìö Kindergarten-Bibliothek</h1>
        <div class="search-container">
          <input type="text" id="search" placeholder="Suchen ..." autocomplete="off" oninput="onSearchChange()">
          <button class="qr-button" onclick="showQRModal()" title="QR-Code scannen">üì∑</button>
          <button class="clear-search-button" onclick="clearSearch()" title="Suchfeld leeren">‚úñÔ∏è</button>
        </div>
        <div id="new-books"></div>
      </div>
    </div>
    <div id="book-list"></div>
    <div class="pagination" id="pagination"></div>
    <div id="modal"><div id="modal-content"></div></div>
    <div id="qr-modal"><div id="qr-modal-content"></div></div>
    <div class="admin-corner">
      <div id="admin-login" class="hidden">
        <input type="password" id="admin-pw" placeholder="Admin-Passwort" style="width: 120px;">
        <button onclick="checkAdmin()">Login</button>
      </div>
      <div id="admin-panel" class="hidden">
        <h3>Buch hinzuf√ºgen</h3>
        <input id="new-id" placeholder="ID (z.B. B-0003)">
        <input id="new-title" placeholder="Titel">
        <input id="new-cat" placeholder="Kategorie">
        <input id="new-age" placeholder="Alter (z.B. 3-6)">
        <label><input type="checkbox" id="new-neu"> Neu</label>
        <textarea id="new-desc" placeholder="Beschreibung"></textarea>
        <input id="new-img" placeholder="Bild-URL (optional)">
        <button onclick="addBook()">‚ûï Hinzuf√ºgen</button>
        <button onclick="exportData()">üìÅ Backup erstellen</button>
        <input type="file" id="import-file" accept=".json" onchange="importData(event)" style="display:none;">
        <button onclick="document.getElementById('import-file').click()">üìÇ Backup laden</button>
        <button onclick="logoutAdmin()">Logout</button>
        <h3>B√ºcher bearbeiten</h3>
        <div id="edit-list"></div>
        <h3>Ausleihverlauf</h3>
        <div id="log-output"></div>
        <button onclick="resetData()">Alles zur√ºcksetzen</button>
      </div>
      <button id="admin-login-btn" onclick="showAdminLogin()">üîë Admin</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script>
    // --- Datenstruktur ---
    let books = [];
    let log = [];
    let page = 1;
    let admin = false;
    let editingIdx = null;

    // --- Gruppen f√ºr Ausleihe ---
    const gruppen = ["Sterne","Sonne","Mond","Regenbogen","Regentropfen","Schneeflocken","Sprachf√∂rderung"];
    // --- DUMMY-DATEN f√ºr Demo ---
    if(!localStorage.books) {
      books = [
        {id:"B-0001", title:"Die kleine Raupe", category:"Bilderbuch", age:"3-6", status:"verf√ºgbar", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/HungryCaterpillar.jpg/120px-HungryCaterpillar.jpg", neu:true, description:"Ein Klassiker f√ºr Kinder."},
        {id:"B-0002", title:"Leo Lausemaus", category:"Vorlesebuch", age:"4-7", status:"verf√ºgbar", img:"", neu:false, description:"Abenteuer von Leo Lausemaus."},
        {id:"B-0003", title:"Conni kommt", category:"Bilderbuch", age:"3-6", status:"verf√ºgbar", img:"", neu:true, description:"Conni erlebt den Kindergarten."}
      ];
      log = [];
      saveData();
    } else {
      books = JSON.parse(localStorage.books);
      log = JSON.parse(localStorage.log || "[]");
    }

    // --- Anzeige ---
    function renderBooks(searchVal="") {
      let filtered = books.filter(b => {
        let s = searchVal.trim().toLowerCase();
        if(!s) return true;
        return (b.title+b.id+b.category+b.age).toLowerCase().includes(s);
      });

      // Pagination
      const total = filtered.filter(b=>!b.neu).length;
      const maxPage = Math.max(1,Math.ceil(total/30));
      if(page > maxPage) page = maxPage;

      // Neue B√ºcher: nur Seite 1 und keine Suche!
      if(page === 1 && !searchVal) {
        renderNewBooks();
      } else {
        document.getElementById("new-books").innerHTML = "";
      }

      let html = "";
      let booksToShow = filtered.filter(b=>!b.neu).slice((page-1)*30, page*30);
      booksToShow.forEach((book,idx) => {
        html += `
        <div class="book">
          ${book.img ? `<img src="${book.img}" class="cover" onclick="showImageModal(${books.indexOf(book)})">` : ""}
          <div class="book-details">
            <strong>${book.id} ‚Äì ${book.title}</strong><br>
            Kategorie: ${book.category}<br>
            Alter: ${book.age}<br>
            Status: ${
              book.status === "verf√ºgbar"
                ? "verf√ºgbar"
                : `geliehen von ${book.borrower || "?"}`
            }<br>
            <button onclick="ausleihenStart(${books.indexOf(book)})">üìï Ausleihen</button>
            <button onclick="zurueckgebenStart(${books.indexOf(book)})">üìó Zur√ºckstellen</button>
          </div>
        </div>`;
      });
      document.getElementById("book-list").innerHTML = html;

      // Pagination
      let pagHtml = "";
      for(let i=1;i<=maxPage;i++) {
        pagHtml += `<button onclick="gotoPage(${i})" class="${i===page?'active':''}">${i}</button>`;
      }
      document.getElementById("pagination").innerHTML = pagHtml;
    }

    function renderNewBooks() {
      const neu = books.filter(b=>b.neu);
      if(!neu.length) { document.getElementById("new-books").innerHTML = ""; return;}
      let html = `<div class="new-books-box"><strong>Neue B√ºcher:</strong><br><br>`;
      neu.forEach((book,idx)=>{
        html += `<div class="book">
            ${book.img ? `<img src="${book.img}" class="cover" onclick="showImageModal(${books.indexOf(book)})">` : ""}
            <div class="book-details">
              <strong>${book.id} ‚Äì ${book.title}</strong><br>
              Kategorie: ${book.category}<br>
              Alter: ${book.age}<br>
              Status: ${book.status === "verf√ºgbar" ? "verf√ºgbar" : `geliehen von ${book.borrower || "?"}`}<br>
              <button onclick="ausleihenStart(${books.indexOf(book)})">üìï Ausleihen</button>
              <button onclick="zurueckgebenStart(${books.indexOf(book)})">üìó Zur√ºckstellen</button>
            </div>
          </div>`;
      });
      html += `</div>`;
      document.getElementById("new-books").innerHTML = html;
    }

    function gotoPage(p) {
      page = p; renderBooks(document.getElementById("search").value);
    }

    function onSearchChange() {
      page = 1;
      renderBooks(document.getElementById("search").value);
    }
    function clearSearch() {
      document.getElementById("search").value = "";
      page = 1;
      renderBooks();
    }

    // --- Modal Bild/Beschreibung ---
    function showImageModal(idx) {
      const b = books[idx];
      let html = `<strong>${b.id} ‚Äì ${b.title}</strong><br>`;
      if(b.img) html += `<img src="${b.img}" style="max-width:180px; border-radius:8px;"><br>`;
      html += `<br>Kategorie: ${b.category}<br>Alter: ${b.age}<br>`;
      html += `<br>${b.description||""}<br>`;
      html += `<br><button onclick="closeModal()">Schlie√üen</button>`;
      document.getElementById("modal-content").innerHTML = html;
      document.getElementById("modal").style.display = "flex";
    }

    function closeModal() { document.getElementById("modal").style.display = "none"; }

    // --- Ausleih-Flow ---
    function ausleihenStart(idx) {
      if(books[idx].status!=="verf√ºgbar") return;
      let modal = `<div style="text-align:center;">
        <div>Gruppe ausw√§hlen:</div><div style="margin:10px 0;">`;
      gruppen.forEach(gruppe => {
        modal += `<button class="group-btn" onclick="ausleihenGruppe(${idx},'${gruppe}')">${gruppe}</button> `;
      });
      modal += `</div>
        <button onclick="closeModal()">Abbrechen</button></div>`;
      document.getElementById("modal-content").innerHTML = modal;
      document.getElementById("modal").style.display = "flex";
    }
    function ausleihenGruppe(idx, gruppe) {
      let modal = `<div style="text-align:center;">
        <div>Buch wirklich f√ºr <strong>${gruppe}</strong> ausleihen?</div>
        <button class="save-btn" onclick="ausleihenFinal(${idx},'${gruppe}')">Ja</button>
        <button onclick="closeModal()">Nein</button>
        </div>`;
      document.getElementById("modal-content").innerHTML = modal;
    }
    function ausleihenFinal(idx, gruppe) {
      books[idx].status = "ausgeliehen";
      books[idx].borrower = gruppe;
      log.push(`${new Date().toLocaleString()}: ${books[idx].id} ausgeliehen an ${gruppe}`);
      closeModal();
      renderBooks(document.getElementById("search").value);
      renderNewBooks();
      updateLog();
      saveData();
    }
    function zurueckgebenStart(idx) {
      if(books[idx].status!=="ausgeliehen") return;
      let modal = `<div style="text-align:center;">
        <div>Buch wirklich zur√ºckstellen?</div>
        <button class="save-btn" onclick="zurueckgebenFinal(${idx})">Ja</button>
        <button onclick="closeModal()">Nein</button>
        </div>`;
      document.getElementById("modal-content").innerHTML = modal;
      document.getElementById("modal").style.display = "flex";
    }
    function zurueckgebenFinal(idx) {
      books[idx].status = "verf√ºgbar";
      log.push(`${new Date().toLocaleString()}: ${books[idx].id} zur√ºckgegeben von ${books[idx].borrower}`);
      books[idx].borrower = "";
      closeModal();
      renderBooks(document.getElementById("search").value);
      renderNewBooks();
      updateLog();
      saveData();
    }

    // --- Admin ---
    function showAdminLogin() {
      document.getElementById("admin-login").classList.remove("hidden");
      document.getElementById("admin-panel").classList.add("hidden");
      document.getElementById("admin-login-btn").style.display="none";
    }
    function checkAdmin() {
      const pw = document.getElementById("admin-pw").value;
      if(pw==="kitadmin") {
        admin = true;
        document.getElementById("admin-login").classList.add("hidden");
        document.getElementById("admin-panel").classList.remove("hidden");
        renderEditList();
      } else {
        alert("Falsches Passwort!");
      }
    }
    function logoutAdmin() {
      admin = false;
      document.getElementById("admin-panel").classList.add("hidden");
      document.getElementById("admin-login-btn").style.display="inline-block";
      document.getElementById("admin-login").classList.add("hidden");
    }

    // --- Buch hinzuf√ºgen ---
    function addBook() {
      const id = document.getElementById("new-id").value.trim();
      const title = document.getElementById("new-title").value.trim();
      const category = document.getElementById("new-cat").value.trim();
      const age = document.getElementById("new-age").value.trim();
      const neu = document.getElementById("new-neu").checked;
      const description = document.getElementById("new-desc").value.trim();
      const img = document.getElementById("new-img").value.trim();
      if(!id||!title||!category||!age) { alert("Bitte alle Pflichtfelder ausf√ºllen!"); return;}
      books.push({id,title,category,age,neu,description,img,status:"verf√ºgbar"});
      saveData();
      renderBooks(document.getElementById("search").value);
      renderNewBooks();
      renderEditList();
      document.getElementById("new-id").value = "";
      document.getElementById("new-title").value = "";
      document.getElementById("new-cat").value = "";
      document.getElementById("new-age").value = "";
      document.getElementById("new-neu").checked = false;
      document.getElementById("new-desc").value = "";
      document.getElementById("new-img").value = "";
    }

    // --- Bearbeiten ---
    function renderEditList() {
      let html = "";
      books.forEach((b,i)=>{
        html += `<div class="book">
          ${b.img ? `<img src="${b.img}" class="cover">` : ""}
          <div class="book-details">
            <strong>${b.id} ‚Äì ${b.title}</strong><br>
            Kategorie: ${b.category}<br>
            Alter: ${b.age}<br>
            Status: ${b.status==="verf√ºgbar"?"verf√ºgbar":`geliehen von ${b.borrower||"?"}`}<br>
            <button class="edit-btn" onclick="editBook(${i})">Bearbeiten</button>
          </div>
        </div>`;
      });
      document.getElementById("edit-list").innerHTML = html;
    }
    function editBook(idx) {
      editingIdx = idx;
      const b = books[idx];
      let html = `<h4>Buch bearbeiten</h4>
        <input id="edit-id" value="${b.id}">
        <input id="edit-title" value="${b.title}">
        <input id="edit-cat" value="${b.category}">
        <input id="edit-age" value="${b.age}">
        <label><input type="checkbox" id="edit-neu" ${b.neu?"checked":""}> Neu</label>
        <textarea id="edit-desc">${b.description||""}</textarea>
        <input id="edit-img" value="${b.img}">
        <button class="save-btn" onclick="saveEdit()">Speichern</button>
        <button onclick="closeModal()">Abbrechen</button>`;
      document.getElementById("modal-content").innerHTML = html;
      document.getElementById("modal").style.display = "flex";
    }
    function saveEdit() {
      const b = books[editingIdx];
      b.id = document.getElementById("edit-id").value;
      b.title = document.getElementById("edit-title").value;
      b.category = document.getElementById("edit-cat").value;
      b.age = document.getElementById("edit-age").value;
      b.neu = document.getElementById("edit-neu").checked;
      b.description = document.getElementById("edit-desc").value;
      b.img = document.getElementById("edit-img").value;
      saveData();
      closeModal();
      renderBooks(document.getElementById("search").value);
      renderNewBooks();
      renderEditList();
    }

    // --- Backup ---
    function exportData() {
      const data = {books,log};
      const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }
    function importData(ev) {
      const file = ev.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          books = data.books||[];
          log = data.log||[];
          saveData();
          renderBooks(document.getElementById("search").value);
          renderNewBooks();
          renderEditList();
          updateLog();
        } catch {
          alert("Fehler beim Laden!");
        }
      }
      reader.readAsText(file);
    }
    function resetData() {
      if(confirm("Wirklich alle Daten l√∂schen?")) {
        books = []; log = [];
        saveData();
        renderBooks(); renderNewBooks(); renderEditList(); updateLog();
      }
    }
    function saveData() {
      localStorage.books = JSON.stringify(books);
      localStorage.log = JSON.stringify(log);
    }

    // --- Ausleih-Log ---
    function updateLog() {
      document.getElementById("log-output").innerText = log.slice(-30).join("\n");
    }

    // --- QR Suche ---
    function showQRModal() {
      let html = `<video id="qr-video" style="width:260px; border-radius:12px;"></video><br>
      <button onclick="closeQRModal()">Abbrechen</button>
      <div id="qr-result"></div>`;
      document.getElementById("qr-modal-content").innerHTML = html;
      document.getElementById("qr-modal").style.display = "flex";
      startQRScanner();
    }
    function closeQRModal() {
      document.getElementById("qr-modal").style.display = "none";
      stopQRScanner();
    }
    let qrStream = null;
    function startQRScanner() {
      const video = document.getElementById("qr-video");
      navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(stream=>{
        qrStream = stream; video.srcObject = stream; video.setAttribute("playsinline",true); video.play();
        scanLoop(video);
      });
    }
    function stopQRScanner() {
      if(qrStream) qrStream.getTracks().forEach(track=>track.stop());
      qrStream = null;
    }
    function scanLoop(video) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      function loop() {
        if(!qrStream) return;
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data,canvas.width,canvas.height);
        if(code) {
          document.getElementById("qr-result").innerHTML = "<strong>QR gefunden:</strong> "+code.data;
          document.getElementById("search").value = code.data;
          closeQRModal();
          onSearchChange();
        } else {
          requestAnimationFrame(loop);
        }
      }
      loop();
    }

    // --- Start ---
    renderBooks();
    renderNewBooks();
    updateLog();
  </script>
</body>
</html>
